import helpers
import difflib

from deepblue_client import DeepBlueClient


class TestScoreMatrixCommand(helpers.TestCase):

  def test_ascore_simple(self):
    epidb = DeepBlueClient(address="localhost", port=31415)
    self.init_base(epidb)

    res = epidb.add_technique("ChIP-seq", "ChIP-sequencing", {}, self.admin_key)
    self.assertSuccess(res)

    broad_peak_format = ",".join([
      "CHROMOSOME",
      "START",
      "END",
      "NAME",
      "SCORE",
      "STRAND",
      "SIGNAL_VALUE",
      "P_VALUE",
      "Q_VALUE",
      ])

    with open("data/wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed", 'r') as f:
      file_data = f.read()
      (res, a_1) = epidb.add_experiment("wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed", "hg19", "H3k4me3", "s1", "ChIPseq", "ENCODE", "wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed from ENCODE",  file_data, broad_peak_format, None, self.admin_key)
      self.assertSuccess(res, a_1)

    with open("data/wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed", 'r') as f:
      file_data = f.read()
      (res, exp) = epidb.add_experiment("wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed", "hg19", "H3k4me3", "s1", "ChIPseq", "ENCODE", "wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed from ENCODE",  file_data, broad_peak_format, None, self.admin_key)
      self.assertSuccess(res, exp)

    # Insert annotation
    cpg_island =  ",".join([
      "CHROMOSOME",
      "START",
      "END",
      "NAME",
      "LENGTH",
      "NUM_CPG",
      "NUM_GC",
      "PER_CPG",
      "PER_CG",
      "OBS_EXP"
      ])

    (s, q_tiling) = epidb.tiling_regions(1000000, "hg19", "chr1", self.admin_key)
    self.assertSuccess(s, q_tiling)

    expected = 'CHROMOSOME\tSTART\tEND\twgEncodeBroadHistoneH1hescH3k27me3StdPk.bed\twgEncodeBroadHistoneH1hescH3k4me3StdPk.bed\nchr1\t0\t1000000\t631.583\t548.931\nchr1\t1000000\t2000000\t479.122\t569.717\nchr1\t2000000\t3000000\t500.223\t487.974\nchr1\t3000000\t4000000\t453.343\t595.174\nchr1\t4000000\t5000000\t557.308\t420.167\nchr1\t5000000\t6000000\t490.75\t462\nchr1\t6000000\t7000000\t547.129\t581.982\nchr1\t7000000\t8000000\t420.364\t532.562\nchr1\t8000000\t9000000\t566.333\t526.619\nchr1\t9000000\t10000000\t658.895\t575.478\nchr1\t10000000\t11000000\t672.9\t562.864\nchr1\t11000000\t12000000\t559.333\t560.484\nchr1\t12000000\t13000000\t489.333\t553.833\nchr1\t13000000\t14000000\t534.5\t572\nchr1\t14000000\t15000000\t543.938\t499\nchr1\t15000000\t16000000\t583.467\t517.895\nchr1\t16000000\t17000000\t611.903\t599.463\nchr1\t17000000\t18000000\t695.355\t574.694\nchr1\t18000000\t19000000\t410.963\t451.615\nchr1\t19000000\t20000000\t677.98\t582.812\nchr1\t20000000\t21000000\t614.013\t530.136\nchr1\t21000000\t22000000\t602.355\t531.435\nchr1\t22000000\t23000000\t440.56\t548.895\nchr1\t23000000\t24000000\t562.298\t541.3\nchr1\t24000000\t25000000\t588.781\t617.296\nchr1\t25000000\t26000000\t536.125\t598.682\nchr1\t26000000\t27000000\t570.833\t549.868\nchr1\t27000000\t28000000\t544.333\t548.217\nchr1\t28000000\t29000000\t653.4\t681.517\nchr1\t29000000\t30000000\t577.154\t524.235\nchr1\t30000000\t31000000\t332.667\t443.333\nchr1\t31000000\t32000000\t540.231\t560.474\nchr1\t32000000\t33000000\t532.909\t640.342\nchr1\t33000000\t34000000\t511.44\t559.463\nchr1\t34000000\t35000000\t387.7\t520\nchr1\t35000000\t36000000\t533.643\t562.294\nchr1\t36000000\t37000000\t613.6\t617.909\nchr1\t37000000\t38000000\t418.4\t506.167\nchr1\t38000000\t39000000\t517.25\t573.308\nchr1\t39000000\t40000000\t555\t570.562\nchr1\t40000000\t41000000\t638.05\t616\nchr1\t41000000\t42000000\t573.58\t507.407\nchr1\t42000000\t43000000\t628.695\t552.5\nchr1\t43000000\t44000000\t406.736\t577.75\nchr1\t44000000\t45000000\t504.908\t563.103\nchr1\t45000000\t46000000\t567.688\t640.192\nchr1\t46000000\t47000000\t475.215\t577.001\nchr1\t47000000\t48000000\t534.834\t485.166\nchr1\t48000000\t49000000\t580.901\t411.684\nchr1\t49000000\t50000000\t275\t465.333\nchr1\t50000000\t51000000\t546.857\t513.444\nchr1\t51000000\t52000000\t690.25\t568\nchr1\t52000000\t53000000\t\t754.909\nchr1\t53000000\t54000000\t557.05\t593.864\nchr1\t54000000\t55000000\t454.762\t532.333\nchr1\t55000000\t56000000\t526.471\t575.583\nchr1\t56000000\t57000000\t332\t392.189\nchr1\t57000000\t58000000\t469.5\t447.049\nchr1\t58000000\t59000000\t672\t402\nchr1\t59000000\t60000000\t664.778\t583.4\nchr1\t60000000\t61000000\t648.2\t644.2\nchr1\t61000000\t62000000\t655.231\t533\nchr1\t62000000\t63000000\t570.5\t599.889\nchr1\t63000000\t64000000\t535.833\t666.444\nchr1\t64000000\t65000000\t570.167\t477.923\nchr1\t65000000\t66000000\t663.786\t568.643\nchr1\t66000000\t67000000\t530.795\t431.932\nchr1\t67000000\t68000000\t626.98\t570.778\nchr1\t68000000\t69000000\t542.6\t578.1\nchr1\t69000000\t70000000\t669.4\t\nchr1\t70000000\t71000000\t869\t801.2\nchr1\t71000000\t72000000\t496\t700.667\nchr1\t72000000\t73000000\t448\t839\nchr1\t73000000\t74000000\t\t\nchr1\t74000000\t75000000\t413\t566\nchr1\t75000000\t76000000\t599.4\t548\nchr1\t76000000\t77000000\t613\t577\nchr1\t77000000\t78000000\t509.4\t697.333\nchr1\t78000000\t79000000\t564\t718.4\nchr1\t79000000\t80000000\t414.667\t537.5\nchr1\t80000000\t81000000\t284\t\nchr1\t81000000\t82000000\t524\t487.5\nchr1\t82000000\t83000000\t423\t528\nchr1\t83000000\t84000000\t\t630.833\nchr1\t84000000\t85000000\t533.889\t660.625\nchr1\t85000000\t86000000\t644.08\t580.529\nchr1\t86000000\t87000000\t622.624\t631.455\nchr1\t87000000\t88000000\t453.5\t597.143\nchr1\t88000000\t89000000\t511\t429\nchr1\t89000000\t90000000\t\t705.5\nchr1\t90000000\t91000000\t542.4\t556.444\nchr1\t91000000\t92000000\t703.062\t559.824\nchr1\t92000000\t93000000\t803.4\t613.4\nchr1\t93000000\t94000000\t493.8\t679.556\nchr1\t94000000\t95000000\t613.737\t591.273\nchr1\t95000000\t96000000\t643.455\t524.333\nchr1\t96000000\t97000000\t769.5\t\nchr1\t97000000\t98000000\t\t450.667\nchr1\t98000000\t99000000\t636.667\t556.8\nchr1\t99000000\t100000000\t744.4\t656.333\nchr1\t100000000\t101000000\t\t808.5\nchr1\t101000000\t102000000\t760.4\t638.167\nchr1\t102000000\t103000000\t441\t572\nchr1\t103000000\t104000000\t360\t670\nchr1\t104000000\t105000000\t477.5\t984\nchr1\t105000000\t106000000\t773.857\t\nchr1\t106000000\t107000000\t411\t\nchr1\t107000000\t108000000\t379\t763\nchr1\t108000000\t109000000\t748.667\t553\nchr1\t109000000\t110000000\t673.4\t622.762\nchr1\t110000000\t111000000\t659.861\t562.767\nchr1\t111000000\t112000000\t656.267\t583.273\nchr1\t112000000\t113000000\t622.667\t560.615\nchr1\t113000000\t114000000\t629.947\t596.474\nchr1\t114000000\t115000000\t312.5\t549.917\nchr1\t115000000\t116000000\t577.143\t654.333\nchr1\t116000000\t117000000\t639.545\t601.273\nchr1\t117000000\t118000000\t447.8\t552.25\nchr1\t118000000\t119000000\t598\t627.4\nchr1\t119000000\t120000000\t479.143\t474.615\nchr1\t120000000\t121000000\t658.364\t598.444\nchr1\t121000000\t122000000\t854.286\t635.867\nchr1\t122000000\t123000000\t\t\nchr1\t123000000\t124000000\t\t\nchr1\t124000000\t125000000\t\t\nchr1\t125000000\t126000000\t\t\nchr1\t126000000\t127000000\t\t\nchr1\t127000000\t128000000\t\t\nchr1\t128000000\t129000000\t\t\nchr1\t129000000\t130000000\t\t\nchr1\t130000000\t131000000\t\t\nchr1\t131000000\t132000000\t\t\nchr1\t132000000\t133000000\t\t\nchr1\t133000000\t134000000\t\t\nchr1\t134000000\t135000000\t\t\nchr1\t135000000\t136000000\t\t\nchr1\t136000000\t137000000\t\t\nchr1\t137000000\t138000000\t\t\nchr1\t138000000\t139000000\t\t\nchr1\t139000000\t140000000\t\t\nchr1\t140000000\t141000000\t\t\nchr1\t141000000\t142000000\t\t\nchr1\t142000000\t143000000\t578\t377\nchr1\t143000000\t144000000\t604.75\t589.833\nchr1\t144000000\t145000000\t588.954\t529.258\nchr1\t145000000\t146000000\t731.935\t626.78\nchr1\t146000000\t147000000\t549.333\t604.231\nchr1\t147000000\t148000000\t552.857\t609.038\nchr1\t148000000\t149000000\t657.5\t572.125\nchr1\t149000000\t150000000\t784\t611.786\nchr1\t150000000\t151000000\t556\t663.1\nchr1\t151000000\t152000000\t539\t652.973\nchr1\t152000000\t153000000\t506\t465.333\nchr1\t153000000\t154000000\t581.385\t625.963\nchr1\t154000000\t155000000\t558.6\t607\nchr1\t155000000\t156000000\t623.739\t698.854\nchr1\t156000000\t157000000\t633.545\t574.277\nchr1\t157000000\t158000000\t482.2\t497.667\nchr1\t158000000\t159000000\t622.917\t545.333\nchr1\t159000000\t160000000\t476.932\t467.412\nchr1\t160000000\t161000000\t501.396\t581.939\nchr1\t161000000\t162000000\t760.318\t698.727\nchr1\t162000000\t163000000\t604.2\t604.917\nchr1\t163000000\t164000000\t554\t496.333\nchr1\t164000000\t165000000\t577\t398.889\nchr1\t165000000\t166000000\t561.429\t618.471\nchr1\t166000000\t167000000\t657.8\t487.625\nchr1\t167000000\t168000000\t503.857\t579.647\nchr1\t168000000\t169000000\t480.5\t611.833\nchr1\t169000000\t170000000\t374\t687.5\nchr1\t170000000\t171000000\t648.333\t565\nchr1\t171000000\t172000000\t426\t630\nchr1\t172000000\t173000000\t576.5\t628.25\nchr1\t173000000\t174000000\t440.372\t697.889\nchr1\t174000000\t175000000\t351.397\t717.5\nchr1\t175000000\t176000000\t415.714\t448.5\nchr1\t176000000\t177000000\t287\t619.25\nchr1\t177000000\t178000000\t487\t633.25\nchr1\t178000000\t179000000\t408.864\t516.929\nchr1\t179000000\t180000000\t518.995\t605.077\nchr1\t180000000\t181000000\t572.636\t578.111\nchr1\t181000000\t182000000\t594.188\t517.371\nchr1\t182000000\t183000000\t584.071\t529.592\nchr1\t183000000\t184000000\t495.138\t595\nchr1\t184000000\t185000000\t605.862\t656.143\nchr1\t185000000\t186000000\t601.2\t622\nchr1\t186000000\t187000000\t418.5\t681.4\nchr1\t187000000\t188000000\t439\t474.5\nchr1\t188000000\t189000000\t\t\nchr1\t189000000\t190000000\t\t\nchr1\t190000000\t191000000\t480.5\t581\nchr1\t191000000\t192000000\t\t\nchr1\t192000000\t193000000\t429\t700\nchr1\t193000000\t194000000\t549\t635.5\nchr1\t194000000\t195000000\t\t\nchr1\t195000000\t196000000\t\t543\nchr1\t196000000\t197000000\t875\t561\nchr1\t197000000\t198000000\t621.333\t524.167\nchr1\t198000000\t199000000\t648.5\t500\nchr1\t199000000\t200000000\t319.907\t485.842\nchr1\t200000000\t201000000\t409.864\t521.017\nchr1\t201000000\t202000000\t516.03\t569.154\nchr1\t202000000\t203000000\t574.6\t575.261\nchr1\t203000000\t204000000\t734.727\t546.188\nchr1\t204000000\t205000000\t486\t522.189\nchr1\t205000000\t206000000\t581.316\t538.711\nchr1\t206000000\t207000000\t559.842\t523.462\nchr1\t207000000\t208000000\t470.4\t657.714\nchr1\t208000000\t209000000\t537.875\t505.333\nchr1\t209000000\t210000000\t545.294\t494.077\nchr1\t210000000\t211000000\t483.167\t586.667\nchr1\t211000000\t212000000\t721.714\t592\nchr1\t212000000\t213000000\t647.294\t674.583\nchr1\t213000000\t214000000\t326.5\t613\nchr1\t214000000\t215000000\t716.053\t489.25\nchr1\t215000000\t216000000\t922\t570.5\nchr1\t216000000\t217000000\t378\t620.75\nchr1\t217000000\t218000000\t595.375\t564\nchr1\t218000000\t219000000\t414\t644.5\nchr1\t219000000\t220000000\t\t537\nchr1\t220000000\t221000000\t557.167\t657.917\nchr1\t221000000\t222000000\t650.429\t516.444\nchr1\t222000000\t223000000\t373\t689.143\nchr1\t223000000\t224000000\t438.059\t514.538\nchr1\t224000000\t225000000\t644.1\t644.692\nchr1\t225000000\t226000000\t437.848\t646.289\nchr1\t226000000\t227000000\t558.235\t583.241\nchr1\t227000000\t228000000\t532.146\t532.5\nchr1\t228000000\t229000000\t633.714\t580.567\nchr1\t229000000\t230000000\t524\t535\nchr1\t230000000\t231000000\t462.833\t562.2\nchr1\t231000000\t232000000\t532.857\t628.778\nchr1\t232000000\t233000000\t527.8\t467.778\nchr1\t233000000\t234000000\t462\t609.667\nchr1\t234000000\t235000000\t591.4\t533.154\nchr1\t235000000\t236000000\t558.5\t624.714\nchr1\t236000000\t237000000\t656.579\t615.6\nchr1\t237000000\t238000000\t795.5\t482\nchr1\t238000000\t239000000\t876\t\nchr1\t239000000\t240000000\t846\t604\nchr1\t240000000\t241000000\t596.75\t561.75\nchr1\t241000000\t242000000\t501.833\t609\nchr1\t242000000\t243000000\t555\t718.75\nchr1\t243000000\t244000000\t396.5\t440\nchr1\t244000000\t245000000\t489.833\t550.722\nchr1\t245000000\t246000000\t478\t554.807\nchr1\t246000000\t247000000\t346.333\t548.667\nchr1\t247000000\t248000000\t497.333\t585.769\nchr1\t248000000\t249000000\t\t831\n'

    (s, req) = epidb.score_matrix({"wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed":"SCORE","wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed":"SCORE"}, "mean",  q_tiling, self.admin_key)

    self.assertSuccess(s, req)
    rs = self.get_regions_request(req)
    self.assertEquals(rs, expected)


    expected = 'CHROMOSOME\tSTART\tEND\twgEncodeBroadHistoneH1hescH3k27me3StdPk.bed\twgEncodeBroadHistoneH1hescH3k4me3StdPk.bed\nchr1\t0\t1000000\t18\t29\nchr1\t1000000\t2000000\t37\t60\nchr1\t2000000\t3000000\t14\t39\nchr1\t3000000\t4000000\t23\t23\nchr1\t4000000\t5000000\t13\t6\nchr1\t5000000\t6000000\t20\t5\nchr1\t6000000\t7000000\t31\t57\nchr1\t7000000\t8000000\t11\t16\nchr1\t8000000\t9000000\t6\t21\nchr1\t9000000\t10000000\t19\t23\nchr1\t10000000\t11000000\t20\t22\nchr1\t11000000\t12000000\t21\t31\nchr1\t12000000\t13000000\t6\t12\nchr1\t13000000\t14000000\t2\t3\nchr1\t14000000\t15000000\t16\t5\nchr1\t15000000\t16000000\t15\t19\nchr1\t16000000\t17000000\t31\t41\nchr1\t17000000\t18000000\t31\t36\nchr1\t18000000\t19000000\t23\t13\nchr1\t19000000\t20000000\t25\t16\nchr1\t20000000\t21000000\t27\t22\nchr1\t21000000\t22000000\t31\t23\nchr1\t22000000\t23000000\t25\t19\nchr1\t23000000\t24000000\t20\t20\nchr1\t24000000\t25000000\t9\t27\nchr1\t25000000\t26000000\t8\t22\nchr1\t26000000\t27000000\t24\t38\nchr1\t27000000\t28000000\t12\t46\nchr1\t28000000\t29000000\t5\t29\nchr1\t29000000\t30000000\t13\t17\nchr1\t30000000\t31000000\t3\t3\nchr1\t31000000\t32000000\t13\t19\nchr1\t32000000\t33000000\t22\t38\nchr1\t33000000\t34000000\t25\t41\nchr1\t34000000\t35000000\t10\t3\nchr1\t35000000\t36000000\t14\t17\nchr1\t36000000\t37000000\t15\t33\nchr1\t37000000\t38000000\t20\t18\nchr1\t38000000\t39000000\t24\t39\nchr1\t39000000\t40000000\t18\t32\nchr1\t40000000\t41000000\t20\t30\nchr1\t41000000\t42000000\t27\t27\nchr1\t42000000\t43000000\t12\t12\nchr1\t43000000\t44000000\t12\t32\nchr1\t44000000\t45000000\t20\t29\nchr1\t45000000\t46000000\t16\t26\nchr1\t46000000\t47000000\t8\t33\nchr1\t47000000\t48000000\t16\t27\nchr1\t48000000\t49000000\t31\t8\nchr1\t49000000\t50000000\t1\t3\nchr1\t50000000\t51000000\t7\t9\nchr1\t51000000\t52000000\t8\t11\nchr1\t52000000\t53000000\t\t11\nchr1\t53000000\t54000000\t20\t22\nchr1\t54000000\t55000000\t21\t24\nchr1\t55000000\t56000000\t17\t12\nchr1\t56000000\t57000000\t2\t4\nchr1\t57000000\t58000000\t6\t5\nchr1\t58000000\t59000000\t8\t4\nchr1\t59000000\t60000000\t9\t10\nchr1\t60000000\t61000000\t5\t5\nchr1\t61000000\t62000000\t13\t10\nchr1\t62000000\t63000000\t10\t9\nchr1\t63000000\t64000000\t6\t9\nchr1\t64000000\t65000000\t6\t13\nchr1\t65000000\t66000000\t14\t14\nchr1\t66000000\t67000000\t4\t5\nchr1\t67000000\t68000000\t9\t12\nchr1\t68000000\t69000000\t5\t10\nchr1\t69000000\t70000000\t5\t\nchr1\t70000000\t71000000\t1\t5\nchr1\t71000000\t72000000\t6\t3\nchr1\t72000000\t73000000\t2\t1\nchr1\t73000000\t74000000\t\t\nchr1\t74000000\t75000000\t2\t1\nchr1\t75000000\t76000000\t5\t5\nchr1\t76000000\t77000000\t1\t5\nchr1\t77000000\t78000000\t5\t3\nchr1\t78000000\t79000000\t9\t10\nchr1\t79000000\t80000000\t3\t2\nchr1\t80000000\t81000000\t1\t\nchr1\t81000000\t82000000\t1\t6\nchr1\t82000000\t83000000\t3\t3\nchr1\t83000000\t84000000\t\t6\nchr1\t84000000\t85000000\t9\t8\nchr1\t85000000\t86000000\t11\t17\nchr1\t86000000\t87000000\t5\t11\nchr1\t87000000\t88000000\t4\t7\nchr1\t88000000\t89000000\t1\t2\nchr1\t89000000\t90000000\t\t4\nchr1\t90000000\t91000000\t5\t9\nchr1\t91000000\t92000000\t16\t17\nchr1\t92000000\t93000000\t5\t5\nchr1\t93000000\t94000000\t5\t9\nchr1\t94000000\t95000000\t19\t11\nchr1\t95000000\t96000000\t11\t12\nchr1\t96000000\t97000000\t4\t\nchr1\t97000000\t98000000\t\t3\nchr1\t98000000\t99000000\t6\t5\nchr1\t99000000\t100000000\t5\t3\nchr1\t100000000\t101000000\t\t8\nchr1\t101000000\t102000000\t5\t6\nchr1\t102000000\t103000000\t1\t2\nchr1\t103000000\t104000000\t1\t1\nchr1\t104000000\t105000000\t2\t1\nchr1\t105000000\t106000000\t7\t\nchr1\t106000000\t107000000\t1\t\nchr1\t107000000\t108000000\t1\t2\nchr1\t108000000\t109000000\t3\t3\nchr1\t109000000\t110000000\t10\t21\nchr1\t110000000\t111000000\t36\t30\nchr1\t111000000\t112000000\t15\t11\nchr1\t112000000\t113000000\t6\t13\nchr1\t113000000\t114000000\t19\t19\nchr1\t114000000\t115000000\t8\t12\nchr1\t115000000\t116000000\t7\t9\nchr1\t116000000\t117000000\t11\t11\nchr1\t117000000\t118000000\t5\t12\nchr1\t118000000\t119000000\t5\t5\nchr1\t119000000\t120000000\t7\t13\nchr1\t120000000\t121000000\t11\t9\nchr1\t121000000\t122000000\t14\t15\nchr1\t122000000\t123000000\t\t\nchr1\t123000000\t124000000\t\t\nchr1\t124000000\t125000000\t\t\nchr1\t125000000\t126000000\t\t\nchr1\t126000000\t127000000\t\t\nchr1\t127000000\t128000000\t\t\nchr1\t128000000\t129000000\t\t\nchr1\t129000000\t130000000\t\t\nchr1\t130000000\t131000000\t\t\nchr1\t131000000\t132000000\t\t\nchr1\t132000000\t133000000\t\t\nchr1\t133000000\t134000000\t\t\nchr1\t134000000\t135000000\t\t\nchr1\t135000000\t136000000\t\t\nchr1\t136000000\t137000000\t\t\nchr1\t137000000\t138000000\t\t\nchr1\t138000000\t139000000\t\t\nchr1\t139000000\t140000000\t\t\nchr1\t140000000\t141000000\t\t\nchr1\t141000000\t142000000\t\t\nchr1\t142000000\t143000000\t2\t1\nchr1\t143000000\t144000000\t4\t12\nchr1\t144000000\t145000000\t14\t17\nchr1\t145000000\t146000000\t36\t29\nchr1\t146000000\t147000000\t3\t13\nchr1\t147000000\t148000000\t14\t26\nchr1\t148000000\t149000000\t28\t16\nchr1\t149000000\t150000000\t19\t42\nchr1\t150000000\t151000000\t2\t30\nchr1\t151000000\t152000000\t9\t37\nchr1\t152000000\t153000000\t4\t6\nchr1\t153000000\t154000000\t13\t27\nchr1\t154000000\t155000000\t10\t26\nchr1\t155000000\t156000000\t23\t41\nchr1\t156000000\t157000000\t33\t65\nchr1\t157000000\t158000000\t15\t9\nchr1\t158000000\t159000000\t12\t9\nchr1\t159000000\t160000000\t20\t14\nchr1\t160000000\t161000000\t11\t29\nchr1\t161000000\t162000000\t22\t33\nchr1\t162000000\t163000000\t5\t12\nchr1\t163000000\t164000000\t5\t3\nchr1\t164000000\t165000000\t6\t9\nchr1\t165000000\t166000000\t14\t17\nchr1\t166000000\t167000000\t10\t8\nchr1\t167000000\t168000000\t7\t17\nchr1\t168000000\t169000000\t2\t6\nchr1\t169000000\t170000000\t4\t8\nchr1\t170000000\t171000000\t3\t5\nchr1\t171000000\t172000000\t3\t9\nchr1\t172000000\t173000000\t2\t4\nchr1\t173000000\t174000000\t7\t9\nchr1\t174000000\t175000000\t1\t6\nchr1\t175000000\t176000000\t14\t6\nchr1\t176000000\t177000000\t1\t4\nchr1\t177000000\t178000000\t7\t4\nchr1\t178000000\t179000000\t7\t14\nchr1\t179000000\t180000000\t9\t13\nchr1\t180000000\t181000000\t11\t9\nchr1\t181000000\t182000000\t16\t10\nchr1\t182000000\t183000000\t14\t14\nchr1\t183000000\t184000000\t10\t11\nchr1\t184000000\t185000000\t10\t7\nchr1\t185000000\t186000000\t5\t5\nchr1\t186000000\t187000000\t2\t5\nchr1\t187000000\t188000000\t1\t4\nchr1\t188000000\t189000000\t\t\nchr1\t189000000\t190000000\t\t\nchr1\t190000000\t191000000\t2\t1\nchr1\t191000000\t192000000\t\t\nchr1\t192000000\t193000000\t1\t1\nchr1\t193000000\t194000000\t5\t4\nchr1\t194000000\t195000000\t\t\nchr1\t195000000\t196000000\t\t1\nchr1\t196000000\t197000000\t1\t3\nchr1\t197000000\t198000000\t3\t12\nchr1\t198000000\t199000000\t2\t2\nchr1\t199000000\t200000000\t2\t2\nchr1\t200000000\t201000000\t6\t19\nchr1\t201000000\t202000000\t33\t26\nchr1\t202000000\t203000000\t10\t23\nchr1\t203000000\t204000000\t11\t32\nchr1\t204000000\t205000000\t26\t37\nchr1\t205000000\t206000000\t19\t38\nchr1\t206000000\t207000000\t19\t13\nchr1\t207000000\t208000000\t5\t7\nchr1\t208000000\t209000000\t16\t6\nchr1\t209000000\t210000000\t17\t13\nchr1\t210000000\t211000000\t6\t9\nchr1\t211000000\t212000000\t7\t14\nchr1\t212000000\t213000000\t17\t12\nchr1\t213000000\t214000000\t2\t9\nchr1\t214000000\t215000000\t19\t12\nchr1\t215000000\t216000000\t1\t2\nchr1\t216000000\t217000000\t1\t4\nchr1\t217000000\t218000000\t8\t3\nchr1\t218000000\t219000000\t3\t4\nchr1\t219000000\t220000000\t\t2\nchr1\t220000000\t221000000\t6\t12\nchr1\t221000000\t222000000\t7\t9\nchr1\t222000000\t223000000\t1\t7\nchr1\t223000000\t224000000\t17\t13\nchr1\t224000000\t225000000\t10\t13\nchr1\t225000000\t226000000\t9\t6\nchr1\t226000000\t227000000\t30\t26\nchr1\t227000000\t228000000\t9\t10\nchr1\t228000000\t229000000\t35\t30\nchr1\t229000000\t230000000\t11\t12\nchr1\t230000000\t231000000\t6\t15\nchr1\t231000000\t232000000\t14\t9\nchr1\t232000000\t233000000\t15\t9\nchr1\t233000000\t234000000\t5\t6\nchr1\t234000000\t235000000\t10\t13\nchr1\t235000000\t236000000\t2\t14\nchr1\t236000000\t237000000\t19\t15\nchr1\t237000000\t238000000\t2\t1\nchr1\t238000000\t239000000\t1\t\nchr1\t239000000\t240000000\t1\t1\nchr1\t240000000\t241000000\t4\t4\nchr1\t241000000\t242000000\t6\t4\nchr1\t242000000\t243000000\t1\t4\nchr1\t243000000\t244000000\t2\t5\nchr1\t244000000\t245000000\t6\t16\nchr1\t245000000\t246000000\t7\t8\nchr1\t246000000\t247000000\t3\t6\nchr1\t247000000\t248000000\t6\t13\nchr1\t248000000\t249000000\t\t1\n'

    (s, req) = epidb.score_matrix({"wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed":"SCORE","wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed":"SCORE"}, "count",  q_tiling, self.admin_key)

    self.assertSuccess(s, req)
    rs = self.get_regions_request(req)
    self.assertEquals(rs, expected)

    expected = 'CHROMOSOME\tSTART\tEND\twgEncodeBroadHistoneH1hescH3k27me3StdPk.bed\twgEncodeBroadHistoneH1hescH3k4me3StdPk.bed\nchr1\t0\t1000000\t11368.5\t15919\nchr1\t1000000\t2000000\t17727.5\t34183\nchr1\t2000000\t3000000\t7003.12\t19031\nchr1\t3000000\t4000000\t10426.9\t13689\nchr1\t4000000\t5000000\t7245\t2521\nchr1\t5000000\t6000000\t9815\t2310\nchr1\t6000000\t7000000\t16961\t33173\nchr1\t7000000\t8000000\t4624\t8521\nchr1\t8000000\t9000000\t3398\t11059\nchr1\t9000000\t10000000\t12519\t13236\nchr1\t10000000\t11000000\t13458\t12383\nchr1\t11000000\t12000000\t11746\t17375\nchr1\t12000000\t13000000\t2936\t6646\nchr1\t13000000\t14000000\t1069\t1716\nchr1\t14000000\t15000000\t8703\t2495\nchr1\t15000000\t16000000\t8752\t9840\nchr1\t16000000\t17000000\t18969\t24578\nchr1\t17000000\t18000000\t21556\t20689\nchr1\t18000000\t19000000\t9452.14\t5871\nchr1\t19000000\t20000000\t16949.5\t9325\nchr1\t20000000\t21000000\t16578.3\t11663\nchr1\t21000000\t22000000\t18673\t12223\nchr1\t22000000\t23000000\t11014\t10429\nchr1\t23000000\t24000000\t11246\t10826\nchr1\t24000000\t25000000\t5299.03\t16667\nchr1\t25000000\t26000000\t4289\t13171\nchr1\t26000000\t27000000\t13700\t20895\nchr1\t27000000\t28000000\t6532\t25218\nchr1\t28000000\t29000000\t3267\t19764\nchr1\t29000000\t30000000\t7503\t8912\nchr1\t30000000\t31000000\t998\t1330\nchr1\t31000000\t32000000\t7023\t10649\nchr1\t32000000\t33000000\t11724\t24333\nchr1\t33000000\t34000000\t12786\t22938\nchr1\t34000000\t35000000\t3877\t1560\nchr1\t35000000\t36000000\t7471\t9559\nchr1\t36000000\t37000000\t9204\t20391\nchr1\t37000000\t38000000\t8368\t9111\nchr1\t38000000\t39000000\t12414\t22359\nchr1\t39000000\t40000000\t9990\t18258\nchr1\t40000000\t41000000\t12761\t18480\nchr1\t41000000\t42000000\t15486.7\t13700\nchr1\t42000000\t43000000\t7544.34\t6630\nchr1\t43000000\t44000000\t4880.84\t18488\nchr1\t44000000\t45000000\t10098.2\t16330\nchr1\t45000000\t46000000\t9083\t16645\nchr1\t46000000\t47000000\t3801.72\t19041\nchr1\t47000000\t48000000\t8557.35\t13099.5\nchr1\t48000000\t49000000\t18007.9\t3293.48\nchr1\t49000000\t50000000\t275\t1396\nchr1\t50000000\t51000000\t3828\t4621\nchr1\t51000000\t52000000\t5522\t6248\nchr1\t52000000\t53000000\t\t8304\nchr1\t53000000\t54000000\t11141\t13065\nchr1\t54000000\t55000000\t9550\t12776\nchr1\t55000000\t56000000\t8950\t6907\nchr1\t56000000\t57000000\t664\t1568.76\nchr1\t57000000\t58000000\t2817\t2235.24\nchr1\t58000000\t59000000\t5376\t1608\nchr1\t59000000\t60000000\t5983\t5834\nchr1\t60000000\t61000000\t3241\t3221\nchr1\t61000000\t62000000\t8518\t5330\nchr1\t62000000\t63000000\t5705\t5399\nchr1\t63000000\t64000000\t3215\t5998\nchr1\t64000000\t65000000\t3421\t6213\nchr1\t65000000\t66000000\t9293\t7961\nchr1\t66000000\t67000000\t2123.18\t2159.66\nchr1\t67000000\t68000000\t5642.82\t6849.34\nchr1\t68000000\t69000000\t2713\t5781\nchr1\t69000000\t70000000\t3347\t\nchr1\t70000000\t71000000\t869\t4006\nchr1\t71000000\t72000000\t2976\t2102\nchr1\t72000000\t73000000\t896\t839\nchr1\t73000000\t74000000\t\t\nchr1\t74000000\t75000000\t826\t566\nchr1\t75000000\t76000000\t2997\t2740\nchr1\t76000000\t77000000\t613\t2885\nchr1\t77000000\t78000000\t2547\t2092\nchr1\t78000000\t79000000\t5076\t7184\nchr1\t79000000\t80000000\t1244\t1075\nchr1\t80000000\t81000000\t284\t\nchr1\t81000000\t82000000\t524\t2925\nchr1\t82000000\t83000000\t1269\t1584\nchr1\t83000000\t84000000\t\t3785\nchr1\t84000000\t85000000\t4805\t5285\nchr1\t85000000\t86000000\t7084.88\t9869\nchr1\t86000000\t87000000\t3113.12\t6946\nchr1\t87000000\t88000000\t1814\t4180\nchr1\t88000000\t89000000\t511\t858\nchr1\t89000000\t90000000\t\t2822\nchr1\t90000000\t91000000\t2712\t5008\nchr1\t91000000\t92000000\t11249\t9517\nchr1\t92000000\t93000000\t4017\t3067\nchr1\t93000000\t94000000\t2469\t6116\nchr1\t94000000\t95000000\t11661\t6504\nchr1\t95000000\t96000000\t7078\t6292\nchr1\t96000000\t97000000\t3078\t\nchr1\t97000000\t98000000\t\t1352\nchr1\t98000000\t99000000\t3820\t2784\nchr1\t99000000\t100000000\t3722\t1969\nchr1\t100000000\t101000000\t\t6468\nchr1\t101000000\t102000000\t3802\t3829\nchr1\t102000000\t103000000\t441\t1144\nchr1\t103000000\t104000000\t360\t670\nchr1\t104000000\t105000000\t955\t984\nchr1\t105000000\t106000000\t5417\t\nchr1\t106000000\t107000000\t411\t\nchr1\t107000000\t108000000\t379\t1526\nchr1\t108000000\t109000000\t2246\t1659\nchr1\t109000000\t110000000\t6734\t13078\nchr1\t110000000\t111000000\t23755\t16883\nchr1\t111000000\t112000000\t9844\t6416\nchr1\t112000000\t113000000\t3736\t7288\nchr1\t113000000\t114000000\t11969\t11333\nchr1\t114000000\t115000000\t2500\t6599\nchr1\t115000000\t116000000\t4040\t5889\nchr1\t116000000\t117000000\t7035\t6614\nchr1\t117000000\t118000000\t2239\t6627\nchr1\t118000000\t119000000\t2990\t3137\nchr1\t119000000\t120000000\t3354\t6170\nchr1\t120000000\t121000000\t7242\t5386\nchr1\t121000000\t122000000\t11960\t9538\nchr1\t122000000\t123000000\t\t\nchr1\t123000000\t124000000\t\t\nchr1\t124000000\t125000000\t\t\nchr1\t125000000\t126000000\t\t\nchr1\t126000000\t127000000\t\t\nchr1\t127000000\t128000000\t\t\nchr1\t128000000\t129000000\t\t\nchr1\t129000000\t130000000\t\t\nchr1\t130000000\t131000000\t\t\nchr1\t131000000\t132000000\t\t\nchr1\t132000000\t133000000\t\t\nchr1\t133000000\t134000000\t\t\nchr1\t134000000\t135000000\t\t\nchr1\t135000000\t136000000\t\t\nchr1\t136000000\t137000000\t\t\nchr1\t137000000\t138000000\t\t\nchr1\t138000000\t139000000\t\t\nchr1\t139000000\t140000000\t\t\nchr1\t140000000\t141000000\t\t\nchr1\t141000000\t142000000\t\t\nchr1\t142000000\t143000000\t1156\t377\nchr1\t143000000\t144000000\t2419\t7078\nchr1\t144000000\t145000000\t8245.35\t8997.39\nchr1\t145000000\t146000000\t26349.6\t18176.6\nchr1\t146000000\t147000000\t1648\t7855\nchr1\t147000000\t148000000\t7740\t15835\nchr1\t148000000\t149000000\t18410\t9154\nchr1\t149000000\t150000000\t14896\t25695\nchr1\t150000000\t151000000\t1112\t19893\nchr1\t151000000\t152000000\t4851\t24160\nchr1\t152000000\t153000000\t2024\t2792\nchr1\t153000000\t154000000\t7558\t16901\nchr1\t154000000\t155000000\t5586\t15782\nchr1\t155000000\t156000000\t14346\t28653\nchr1\t156000000\t157000000\t20907\t37328\nchr1\t157000000\t158000000\t7233\t4479\nchr1\t158000000\t159000000\t7475\t4908\nchr1\t159000000\t160000000\t9538.65\t6543.77\nchr1\t160000000\t161000000\t5515.35\t16876.2\nchr1\t161000000\t162000000\t16727\t23058\nchr1\t162000000\t163000000\t3021\t7259\nchr1\t163000000\t164000000\t2770\t1489\nchr1\t164000000\t165000000\t3462\t3590\nchr1\t165000000\t166000000\t7860\t10514\nchr1\t166000000\t167000000\t6578\t3901\nchr1\t167000000\t168000000\t3527\t9854\nchr1\t168000000\t169000000\t961\t3671\nchr1\t169000000\t170000000\t1496\t5500\nchr1\t170000000\t171000000\t1945\t2825\nchr1\t171000000\t172000000\t1278\t5670\nchr1\t172000000\t173000000\t1153\t2513\nchr1\t173000000\t174000000\t3082.6\t6281\nchr1\t174000000\t175000000\t351.397\t4305\nchr1\t175000000\t176000000\t5820\t2691\nchr1\t176000000\t177000000\t287\t2477\nchr1\t177000000\t178000000\t3409\t2533\nchr1\t178000000\t179000000\t2862.05\t7237\nchr1\t179000000\t180000000\t4670.95\t7866\nchr1\t180000000\t181000000\t6299\t5203\nchr1\t181000000\t182000000\t9507\t5173.71\nchr1\t182000000\t183000000\t8177\t7414.29\nchr1\t183000000\t184000000\t4951.38\t6545\nchr1\t184000000\t185000000\t6058.62\t4593\nchr1\t185000000\t186000000\t3006\t3110\nchr1\t186000000\t187000000\t837\t3407\nchr1\t187000000\t188000000\t439\t1898\nchr1\t188000000\t189000000\t\t\nchr1\t189000000\t190000000\t\t\nchr1\t190000000\t191000000\t961\t581\nchr1\t191000000\t192000000\t\t\nchr1\t192000000\t193000000\t429\t700\nchr1\t193000000\t194000000\t2745\t2542\nchr1\t194000000\t195000000\t\t\nchr1\t195000000\t196000000\t\t543\nchr1\t196000000\t197000000\t875\t1683\nchr1\t197000000\t198000000\t1864\t6290\nchr1\t198000000\t199000000\t1297\t1000\nchr1\t199000000\t200000000\t639.814\t971.684\nchr1\t200000000\t201000000\t2459.19\t9899.32\nchr1\t201000000\t202000000\t17029\t14798\nchr1\t202000000\t203000000\t5746\t13231\nchr1\t203000000\t204000000\t8082\t17478\nchr1\t204000000\t205000000\t12636\t19321\nchr1\t205000000\t206000000\t11045\t20471\nchr1\t206000000\t207000000\t10637\t6805\nchr1\t207000000\t208000000\t2352\t4604\nchr1\t208000000\t209000000\t8606\t3032\nchr1\t209000000\t210000000\t9270\t6423\nchr1\t210000000\t211000000\t2899\t5280\nchr1\t211000000\t212000000\t5052\t8288\nchr1\t212000000\t213000000\t11004\t8095\nchr1\t213000000\t214000000\t653\t5517\nchr1\t214000000\t215000000\t13605\t5871\nchr1\t215000000\t216000000\t922\t1141\nchr1\t216000000\t217000000\t378\t2483\nchr1\t217000000\t218000000\t4763\t1692\nchr1\t218000000\t219000000\t1242\t2578\nchr1\t219000000\t220000000\t\t1074\nchr1\t220000000\t221000000\t3343\t7895\nchr1\t221000000\t222000000\t4553\t4648\nchr1\t222000000\t223000000\t373\t4824\nchr1\t223000000\t224000000\t7447\t6689\nchr1\t224000000\t225000000\t6441\t8381\nchr1\t225000000\t226000000\t3940.63\t3877.73\nchr1\t226000000\t227000000\t16747\t15164.3\nchr1\t227000000\t228000000\t4789.32\t5325\nchr1\t228000000\t229000000\t22180\t17417\nchr1\t229000000\t230000000\t5764\t6420\nchr1\t230000000\t231000000\t2777\t8433\nchr1\t231000000\t232000000\t7460\t5659\nchr1\t232000000\t233000000\t7917\t4210\nchr1\t233000000\t234000000\t2310\t3658\nchr1\t234000000\t235000000\t5914\t6931\nchr1\t235000000\t236000000\t1117\t8746\nchr1\t236000000\t237000000\t12475\t9234\nchr1\t237000000\t238000000\t1591\t482\nchr1\t238000000\t239000000\t876\t\nchr1\t239000000\t240000000\t846\t604\nchr1\t240000000\t241000000\t2387\t2247\nchr1\t241000000\t242000000\t3011\t2436\nchr1\t242000000\t243000000\t555\t2875\nchr1\t243000000\t244000000\t793\t2200\nchr1\t244000000\t245000000\t2939\t8811.55\nchr1\t245000000\t246000000\t3346\t4438.45\nchr1\t246000000\t247000000\t1039\t3292\nchr1\t247000000\t248000000\t2984\t7615\nchr1\t248000000\t249000000\t\t831\n'

    (s, req) = epidb.score_matrix({"wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed":"SCORE","wgEncodeBroadHistoneH1hescH3k4me3StdPk.bed":"SCORE"}, "sum",  q_tiling, self.admin_key)

    self.assertSuccess(s, req)
    rs = self.get_regions_request(req)
    self.assertEquals(rs, expected)

  def test_score_matrix_wrong_experiment(self):
    epidb = DeepBlueClient(address="localhost", port=31415)
    self.init_base(epidb)

    (s, q_tiling) = epidb.tiling_regions(10000000, "hg19", "chr1", self.admin_key)
    self.assertSuccess(s, q_tiling)

    (s, req) = epidb.score_matrix({"wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed":"SCORE"}, "mean",  q_tiling, self.admin_key)
    self.assertFailure(s, req)
    self.assertEquals(req, "101000:Experiment 'wgEncodeBroadHistoneH1hescH3k27me3StdPk.bed' does not exists.")

    sample_id = self.sample_ids[0]

    self.insert_experiment(epidb, "hg19_chr1_1", sample_id)
    (s, req) = epidb.score_matrix({"hg19_chr1_1":"VALUE"}, "mean",  q_tiling, self.admin_key)
    self.assertFailure(s, req)
    self.assertEquals(req, "101007:The experiment 'hg19_chr1_1' does not have the column 'VALUE'.")
